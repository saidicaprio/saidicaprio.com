<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>证书格式和HTTPS设置 | Sai&#39;s Cabin</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="Hi, I&#39;m SaiDicaprio, a iOS Developer from China.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="证书格式和HTTPS设置 | Sai&#39;s Cabin">
    <meta name="twitter:description" content="Hi, I&#39;m SaiDicaprio, a iOS Developer from China.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="证书格式和HTTPS设置 | Sai&#39;s Cabin">
    <meta property="og:description" content="Hi, I&#39;m SaiDicaprio, a iOS Developer from China.">

    
    <meta name="author" content="贺嘉炜">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Sai&#39;s Cabin" href="/atom.xml">
    

    <link rel="canonical" href="https://saidicaprio.com/2017/12/证书格式和HTTPS设置/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Sai&#39;s Cabin 的主页"><img src="/images/avatar.jpg" width="80" alt="Sai&#39;s Cabin logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Sai&#39;s Cabin">Sai&#39;s Cabin</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">落月摇情满江树</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">Hi, I'm SaiDicaprio, a iOS Developer from China.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
              <li class="navigation__item"><a href="/">首页</a></li>
            
              <li class="navigation__item"><a href="./aboutme">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/hjw6160602" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-blue"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2017-12-06T11:31:14.000Z" class="post-list__meta--date date">2017-12-06</time> &#8226; <span class="post-meta__tags tags">于&nbsp; </span>
      <span class="page-pv">
      &nbsp;阅读&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">证书格式和HTTPS设置</h1>
  </header>

  <section class="post">
    <p><a href="#一https的方式">一、HTTPS的方式</a></p>
<ul>
<li><a href="#ssl">SSL</a></li>
<li><a href="#openssl">OpenSSL</a></li>
<li><a href="#x509-证书标准">X.509 证书标准</a></li>
</ul>
<p><a href="#二证书编码格式">二、证书编码格式</a></p>
<ul>
<li><a href="#21-pem">2.1 PEM</a></li>
<li><a href="#22-der">2.2 DER</a></li>
</ul>
<p><a href="#三相关的文件扩展名">三、相关的文件扩展名</a></p>
<ul>
<li><a href="#crt">CRT</a></li>
<li><a href="#cer">CER</a></li>
<li><a href="#key">KEY</a></li>
<li><a href="#csr">CSR</a></li>
<li><a href="#p12pfx">P12(PFX)</a></li>
<li><a href="#jks">JKS</a></li>
</ul>
<p><a href="#四证书编码的转换">四、证书编码的转换</a></p>
<ul>
<li><a href="#41-pem转为der">4.1 PEM转为DER</a></li>
<li><a href="#42-der转为pem">4.2 DER转为PEM </a></li>
</ul>
<p><a href="#五获得证书">五、获得证书</a></p>
<ul>
<li><a href="#向权威证书颁发机构申请证书">向权威证书颁发机构申请证书</a></li>
<li><a href="#生成自签名的证书">生成自签名的证书</a></li>
</ul>
<p><a href="#六ios中实现校验https证书">六、iOS中实现校验HTTPS证书</a></p>
<ul>
<li><a href="#afsecuritypolicy">AFSecurityPolicy</a></li>
</ul>
<p><a href="#七校验证书之后的app如何通过charles抓包">七、校验证书之后的App如何通过Charles抓包</a></p>
<h2 id="一、HTTPS的方式"><a href="#一、HTTPS的方式" class="headerlink" title="一、HTTPS的方式"></a>一、HTTPS的方式</h2><h3 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h3><p><code>Secure Sockets Layer</code>，现在应该叫<code>TLS</code>( <code>Transport Layer Security</code> ) 安全传输层协议 ，但由于习惯问题，我们还是叫<code>SSL</code>比较多。<code>HTTP</code>协议默认情况下是不加密内容的，这样就很可能在内容传播的时候被别人监听到，对于安全性要求较高的场合，必须要加密，<code>HTTPS</code>就是带加密的<code>HTTP</code>协议，而<code>HTTPS</code>的加密是基于<code>SSL</code>的，它执行的是一个比较下层的加密，也就是说，在加密前，你的服务器程序在干嘛，加密后也一样在干嘛，不用动，这个加密对用户和开发者来说都是透明的。</p>
<h3 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h3><p>简单地说，<code>OpenSSL</code>是<code>SSL</code>的一个实现，<code>SSL</code>只是一种规范。理论上来说，<code>SSL</code>这种规范是安全的，目前的技术水平很难破解，但<code>SSL</code>的实现就可能有些漏洞。<code>OpenSSL</code>还提供了一大堆强大的工具软件，90%我们都用不到。</p>
<h3 id="X-509-证书标准"><a href="#X-509-证书标准" class="headerlink" title="X.509 证书标准"></a>X.509 证书标准</h3><p><code>X.509</code> 是由国际电信联盟（<code>ITU-T</code>）制定的数字证书标准，是一种广泛使用的数字证书标准，该标准定义了证书中应该包含哪些内容。<code>SSL</code> 使用的就是这种证书标准，编码格式同样的<code>X.509</code> 证书。</p>
<h2 id="二、证书编码格式"><a href="#二、证书编码格式" class="headerlink" title="二、证书编码格式"></a>二、证书编码格式</h2><blockquote>
</blockquote>
<ul>
<li>PEM ： <code>BASE64</code>编码的证书</li>
<li>DER ：二进制格式的证书</li>
</ul>
<h3 id="2-1-PEM"><a href="#2-1-PEM" class="headerlink" title="2.1 PEM"></a>2.1 PEM</h3><p><code>Privacy Enhanced Mail</code> 打开看文本格式</p>
<p> <code>-----BEGIN...</code> 开头</p>
<p>  <code>-----END...</code> 结尾</p>
<p>  内容是<code>BASE64</code>编码。查看<code>PEM</code>格式证书的信息:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in certificate.pem -text -noout</span><br></pre></td></tr></table></figure>
<p><code>Apache</code>和 <code>*NIX</code>服务器偏向于使用这种编码格式。</p>
<h3 id="2-2-DER"><a href="#2-2-DER" class="headerlink" title="2.2 DER"></a>2.2 DER</h3><p><code>Distinguished Encoding Rules</code> 打开看是二进制格式，不可读。<code>Java</code>和<code>Windows</code>服务器偏向于使用这种编码格式。</p>
<h3 id="三、相关的文件扩展名"><a href="#三、相关的文件扩展名" class="headerlink" title="三、相关的文件扩展名"></a>三、相关的文件扩展名</h3><blockquote>
</blockquote>
<ul>
<li>CRT ：两种编码都有可能，大多数是<code>PEM</code>编码</li>
<li>CER：两种编码都有可能，大多数是<code>DER</code>编码</li>
<li>KEY ：两种编码都有可能，存放公钥或者私钥</li>
<li>CSR ：证书签名请求（不是证书）</li>
<li>P12(PFX) ：包含了证书及私钥</li>
<li>JKS ：包含了证书及私钥（Java的专利 ）<blockquote>
</blockquote>
</li>
</ul>
<p><code>PEM</code>和<code>DER</code>这两种编码格式导出的文件扩展名并不一定叫<code>PEM</code>或者<code>DER</code>，常见的扩展名还有以下这些，它们除了编码格式可能不同之外，内容也有差别，但大多数都能相互转换编码格式。</p>
<h3 id="CRT"><a href="#CRT" class="headerlink" title="CRT"></a>CRT</h3><p><code>CRT</code> 是 Certificate 的三个字母，证书的意思，常见于 <code>*NIX</code>系统，有可能是<code>PEM</code>编码，也有可能是<code>DER</code>编码，大多数应该是<code>PEM</code>编码。</p>
<h3 id="CER"><a href="#CER" class="headerlink" title="CER"></a>CER</h3><p><code>CER</code> 还是 Certificate，还是证书，常见于<code>Windows</code>系统，同样的，可能是<code>PEM</code>编码，也可能是<code>DER</code>编码，大多数应该是<code>DER</code>编码。</p>
<h3 id="KEY"><a href="#KEY" class="headerlink" title="KEY"></a>KEY</h3><p><code>KEY</code> 通常用来存放一个公钥或者私钥，并非<code>X.509</code>证书，编码同样的，可能是<code>PEM</code> 也可能是<code>DER</code>。查看<code>KEY</code>的办法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -in mykey.key -text -noout</span><br></pre></td></tr></table></figure>
<p>如果是<code>DER</code>格式的话，同理应该这样了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -in mykey.key -text -noout -inform der</span><br></pre></td></tr></table></figure>
<h3 id="CSR"><a href="#CSR" class="headerlink" title="CSR"></a>CSR</h3><p><code>Certificate Signing Request</code> 即证书签名请求，这个并不是证书，而是向权威证书颁发机构获得签名证书的申请，其核心内容是一个公钥（当然还附带了一些别的信息），在生成这个申请的时候，同时也会生成一个私钥，私钥要自己保管好。做过iOS APP的都应该知道是怎么向苹果申请开发者证书的。<br>查看的办法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openssl req -noout -text -in my.csr</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">（如果是DER格式的话照旧加上`-inform der`，这里不写了）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>## P12(PFX)</span><br><span class="line">`Predecessor of PKCS#12` 对 `*nix` 服务器来说，一般 `CRT` 和 `KEY` 是分开存放在不同文件中的，但Windows的IIS则将它们存在一个`PFX`文件中，（因此这个文件包含了证书及私钥）这样会不会不安全？应该不会，PFX通常会有一个“提取密码”，你想把里面的东西读取出来的话，它就要求你提供提取密码，`PFX`使用的时`DER`编码，如何把`PFX`转换为`PEM`编码？</span><br><span class="line"></span><br><span class="line">``` shell</span><br><span class="line">openssl pkcs12 -in for-ii.pfx -out for-iis.pem -nodes</span><br></pre></td></tr></table></figure>
<p>这个时候会提示你输入提取代码。 <code>for-iis.pem</code>就是可读的文本。生成<code>pfx</code>的命令类似这样:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -export -out certificate.pfx -inkey privateKey.key -in certificate.crt -certfile CACert.crt</span><br></pre></td></tr></table></figure>
<p>其中<code>CACert.crt</code>是<code>CA</code>（权威证书颁发机构）的根证书，有的话也通过-certfile参数一起带进去。这么看来，PFX其实是个证书密钥库。</p>
<h3 id="JKS"><a href="#JKS" class="headerlink" title="JKS"></a>JKS</h3><p><code>JKS</code>- 即<code>Java Key Storage</code>，这是<code>Java</code>的专利，跟<code>OpenSSL</code>关系不大，利用<code>Java</code>的一个叫<code>keytool</code>的工具，可以将<code>PFX</code>转为<code>JKS</code>，当然了，<code>keytool</code>也能直接生成<code>JKS</code>。</p>
<h2 id="四、证书编码的转换"><a href="#四、证书编码的转换" class="headerlink" title="四、证书编码的转换"></a>四、证书编码的转换</h2><h3 id="4-1-PEM转为DER"><a href="#4-1-PEM转为DER" class="headerlink" title="4.1 PEM转为DER"></a>4.1 <code>PEM</code>转为<code>DER</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in cert.crt -outform der -out cert.der</span><br></pre></td></tr></table></figure>
<h3 id="4-2-DER转为PEM"><a href="#4-2-DER转为PEM" class="headerlink" title="4.2 DER转为PEM"></a>4.2 <code>DER</code>转为<code>PEM</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in cert.crt -inform der -outform pem -out cert.pem</span><br></pre></td></tr></table></figure>
<p>（提示:要转换<code>KEY</code>文件也类似，只不过把<code>x.509</code>换成<code>rsa</code>，要转<code>CSR</code>的话，把<code>x.509</code>换成<code>req</code>）</p>
<h2 id="五、获得证书"><a href="#五、获得证书" class="headerlink" title="五、获得证书"></a>五、获得证书</h2><h3 id="向权威证书颁发机构申请证书"><a href="#向权威证书颁发机构申请证书" class="headerlink" title="向权威证书颁发机构申请证书"></a>向权威证书颁发机构申请证书</h3><p>用这命令生成一个<code>CSR</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -newkey rsa:2048 -new -nodes -keyout my.key -out my.csr</span><br></pre></td></tr></table></figure>
<p>把<code>CSR</code>交给权威证书颁发机构，权威证书颁发机构对此进行签名，完成。保留好<code>CSR</code>，当权威证书颁发机构颁发的证书过期的时候，你还可以用同样的<code>CSR</code>来申请新的证书，key保持不变。</p>
<h3 id="生成自签名的证书"><a href="#生成自签名的证书" class="headerlink" title="生成自签名的证书"></a>生成自签名的证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem</span><br></pre></td></tr></table></figure>
<p>在生成证书的过程中会要你填一堆的东西，其实真正要填的只有<code>Common Name</code>，通常填写你服务器的域名，如<code>lvmama.com</code>，或者你服务器的IP地址，其它都可以留空的。生产环境中还是不要使用自签的证书，否则浏览器会不认，或者如果你是企业应用的话能够强制让用户的浏览器接受你的自签证书也行。向权威机构要证书通常是要钱的，但现在也有免费的，仅仅需要一个简单的域名验证即可。</p>
<h3 id="导出驴妈妈的证书"><a href="#导出驴妈妈的证书" class="headerlink" title="导出驴妈妈的证书"></a>导出驴妈妈的证书</h3><p>打开火狐浏览器 输入<code>https://api3g2.lvmama.com/</code>，点击地址栏前面的小锁图标</p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Snip20171130_2.png" alt=""></p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Snip20171130_3.png" alt=""></p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Snip20171130_4.png" alt=""></p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Snip20171130_7.png" alt=""></p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Snip20171130_8.png" alt=""></p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Snip20171130_10.png" alt=""></p>
<p>最终导出证书到本地。</p>
<h2 id="六、iOS中实现校验HTTPS证书"><a href="#六、iOS中实现校验HTTPS证书" class="headerlink" title="六、iOS中实现校验HTTPS证书"></a>六、iOS中实现校验HTTPS证书</h2><p>将导出到本地的证书文件<code>.crt</code>结尾的重命名为<code>.cer</code>格式的证书，然后加入到本地的Bundle包中。这里之所以将证书格式设置为<code>.cer</code>结尾，是因为<code>AFN</code>只会去读取<code>.cer</code>格式的证书文件。</p>
<p><strong>注意在导入证书的时候一定概要将 <code>Target Membership</code> 勾选上才会存在于App中</strong></p>
<p><code>AFNetworking</code>中实现了校验<code>SSL</code>证书的过程只需要将<code>AFHTTPSessionManager</code>的<code>securityPolicy</code>属性赋值即可。</p>
<p>下面来看<code>AFSecurityPolicy</code>这个类的一些属性和内容。</p>
<h3 id="AFSecurityPolicy"><a href="#AFSecurityPolicy" class="headerlink" title="AFSecurityPolicy"></a>AFSecurityPolicy</h3><ul>
<li><code>allowInvalidCertificates</code> 是否信任无效或者过期的证书（默认是<code>NO</code>）  </li>
<li><code>validatesDomainName</code>是否验证证书的域名（默认是<code>YES</code>） </li>
<li><code>SSLPinningMode</code> (<strong>readonly</strong>) 初始化<code>securityPolicy</code>对象的时候赋值<ul>
<li><code>AFSSLPinningModeNone</code> 不使用pin到的证书来验证服务器</li>
<li><code>AFSSLPinningModePublicKey</code> 通过pin到的证书中的公钥来验证host证书</li>
<li><code>AFSSLPinningModeCertificate</code> 通过pin到的证书来验证host证书</li>
</ul>
</li>
</ul>
<p>方法<code>[AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeCertificate]</code>会在生成<code>AFSecurityPolicy</code>的实例化对象<code>securityPolicy</code>的时候去App的Bundle包中寻找<code>.cer</code>结尾的证书文件作为校验项。</p>
<h4 id="NSSet-pinnedCertificates"><a href="#NSSet-pinnedCertificates" class="headerlink" title="NSSet \ *pinnedCertificates"></a>NSSet \<nsdata *=""> *pinnedCertificates</nsdata></h4><p><code>pinnedCertificates</code>根据<code>SSL</code>的<code>pinning mode</code>来评估服务器是否可信任的证书<br> 这个属性默认会在编译<code>AFNetworking</code>的<code>target</code>中去寻找任意的以<code>.cer</code>为后缀的证书文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span> *)defaultPinnedCertificates &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSSet</span> *_defaultPinnedCertificates = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="built_in">NSBundle</span> *bundle = [<span class="built_in">NSBundle</span> bundleForClass:[<span class="keyword">self</span> <span class="keyword">class</span>]];</span><br><span class="line">        _defaultPinnedCertificates = [<span class="keyword">self</span> certificatesInBundle:bundle];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _defaultPinnedCertificates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>提示：如果你是以嵌入<code>framework</code>的方式来使用<code>AFNetworking</code>，那么默认将不会 <code>pin</code> 到证书，需要使用 <code>certificatesInBundle:bundle</code>  方法来从target中加载证书，然后创建一个policy对象来调用<code>policyWithPinningMode:withPinnedCertificates</code>方法 <code>pin</code> 到证书。</p>
</blockquote>
<p>如果pinning是激活的，那么 <code>evaluateServerTrust:forDomain:</code> 方法会在匹配到任一证书之后返回true。</p>
<p><strong>Tips：</strong> 在早起的AFN版本中，可能会有证书链的设置<code>validatesCertificateChai</code>，最新的AFN里面已经去掉了证书链。</p>
<blockquote>
<p>Full Certificate Chain Validation has been removed from AFSecurityPolicy. As discussed in #2744, there was no documented security advantage to pinning against an entire certificate chain. If you were using full certificate chain, please determine and select the most ideal certificate in your chain to pin against.</p>
</blockquote>
<p><code>2.6.0</code>版本的AFN中去掉了证书链的验证。在<a href="https://github.com/AFNetworking/AFNetworking/issues/2744" target="_blank" rel="noopener"><code>#2744</code></a>这个github的issue里讨论了 去校验整个证书链并没有增加任何安全性。也没有任何能够证明对证书链的校验会增加安全性的文档。</p>
<blockquote>
<p>I spoke with the Apple Engineering Security team in depth last week in the WWDC labs, and they agreed there was no additional security value in validating the entire chain. Their own implementation pins against only one certificate in the chain. It’s important to understand the trade offs of what level to pin against, but once that decision is made, there is no value in pinning against a higher cert once that has been done.<br>Unless someone can provide a specific vulnerability that pinning against the entire chain would provide more security than pinning against a single cert, I’ll be deprecating the entire chain validation in a future release.</p>
</blockquote>
<h2 id="七、校验证书之后的App如何通过Charles抓包"><a href="#七、校验证书之后的App如何通过Charles抓包" class="headerlink" title="七、校验证书之后的App如何通过Charles抓包"></a>七、校验证书之后的App如何通过Charles抓包</h2><p><strong>如果是自己的模块：</strong><br>只需要在自己的模块里面的<code>AppDelegate</code>中加入</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[TMCache sharedCache] setObject:@(<span class="literal">YES</span>) forKey:<span class="string">@"validateServer"</span>];</span><br></pre></td></tr></table></figure>
<p>这句代码即可。</p>
<p><strong>如果是主工程：</strong> 不需要加代码，需要在<code>DebugViewController</code>里打开Charles抓包开关即可。</p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/Simulator Screen Shot - iPhone 8 Plus - 2017-11-30 at 14.42.42.png" width="414" height="736"></p>
<p><strong>如果是在真机上跑，并且系统在iOS11以上，在下载了<code>Charles</code>的证书之后，还需要打开信任证书的开关。</strong></p>
<p><img src="http://lvioscode.com/ios_documents/documents/raw/master/%E7%9F%A5%E8%AF%86%E5%BA%93/images/WechatIMG119.jpeg" width="414" height="736"></p>
<p><strong>采用HTTPS证书校验带来的好处</strong></p>
<ul>
<li>使用证书校验认证用户和服务器，确保数据发送到正确的客户机和服务器；</li>
<li>防止数据在传输过程中不被窃取、改变，确保数据的完整性。</li>
<li>报文无法被黑客抓取和修改，大幅增加了中间人攻击的成本。</li>
</ul>
<p>参考文档：</p>
<p><a href="https://blog.myssl.com" target="_blank" rel="noopener">https://blog.myssl.com</a><br><a href="https://www.sslshopper.com/ssl-converter.html" target="_blank" rel="noopener">https://www.sslshopper.com/ssl-converter.html</a></p>
<p><a href="http://www.360doc.com/content/15/0520/10/21412_471902987.shtml" target="_blank" rel="noopener">http://www.360doc.com/content/15/0520/10/21412_471902987.shtml</a></p>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/03/know-html-first-time/" title="初识HTML">初识HTML</a></h2>
                <p class="excerpt">
                
                一、HTML的基础标签：1.1. html 标签 &amp;lt;html&amp;gt;作用：告诉浏览器这是一个网页，也就是说告诉浏览器我是是一个HTML文档
注意点：其他所有的标签都必须写在html标签里面，也就是写在html开始标签和结束标签中间。
1.2. head 标签&amp;lt;head&amp;gt;作用：用于给
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-03-07T02:24:12.000Z" class="post-list__meta--date date">2018-03-07</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/大前端实录/">大前端实录</a>
</span><a class="btn-border-small" href="/2018/03/know-html-first-time/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/09/Realm数据库/" title="Realm数据库">Realm数据库</a></h2>
                <p class="excerpt">
                
                Realm是什么？Realm是由Y Combinator公司孵化出来的一款可以用于iOS(同样适用于Swift&amp;amp;Objective-C)和Android的跨平台移动数据库。支持的平台包括Java，Objective-C，Swift，React Native，Xamarin。从2012年开发打
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-09-13T02:31:10.000Z" class="post-list__meta--date date">2017-09-13</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;</span><a class="btn-border-small" href="/2017/09/Realm数据库/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2019 - 本站使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题,
        由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
    </span>
    
</footer>


        </div>
    </div>

     
    


    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
